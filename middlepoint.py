import numpy as np
import matplotlib.pyplot as plt
from sympy import lambdify, abc
from utils.derivate import derivate

def middlepoint(a: int, b: int, funcExp):
    """
    Fonction d'intégration numérique utilisant la méthode du point milieu.
    Cette fonction calcule la valeur rapprochée de l'intégration,
    le taux d'erreur et la valeur (plus ou moins) exacte de l'intégration d'une expression donnée.
    Les représentations graphiques de l'expression et du résultat de son intégration sont aussi données.

    Paramètres
    ==========

    `a` (entier): Première borne d'intégration.
    `b` (entier): Seconde borne d'intégration.
    `funcExp` (expression Sympy): Expression mathématiques analysée par Sympy.
    """

    func = lambdify(abc.x, funcExp) # Fonction lambda de l'expression (utilisable par python)
    derivsec = derivate(funcExp, 2) # Dérivation seconde de l'expression
    derivsecfunc = lambdify(abc.x, derivsec) # Fonction lambda de l'expression dérivée

    # Point milieu
    x0 = (a+b)/2
    f0 = func(x0)

    # Hauteur du rectangle
    h = b-a

    # Points de la fonction
    x = np.linspace(a, b, 100)
    y = func(x)
    if(funcExp.is_constant()): # Correction du problème de dimension en cas d'expression constante
        y = np.full(x.shape, func(x))

    # Calcul de l'erreur
    _M = np.amax(derivsecfunc(x))
    e = ((h**3)/3)*_M

    # Calcul de l'intégrale rapprochée
    approx = f0*h
    result = e + approx
    print(f"\nCalcul par méthode du point milieu:")
    print(f"Expression: f(x)={funcExp}")
    print(f"Erreur: {e}\tValeur rapprochée (sans erreur): {approx}")
    print(f"Milieu: {(x0, f0)}\tRésultat (avec erreur): {result}\n")
    
    # Affichage des résultats

    plt.title("Méthode point milieu")
    
    plt.plot(x, y, color='red', label=f"f(x)={funcExp}") # Graphique de f(x)
    
    plt.axhline(f0, color='black', ls="--", alpha=0.5) # Borne supérieure du rectangle
    plt.fill_between(x, f0, color="green", alpha=0.2, label=f"Valeur rapprochée ({approx})")

    plt.plot([x0, x0], [f0, 0], 'k-', alpha=0.5) # Hauteur du rectangle

    plt.scatter(x0, f0, color='black') # Point milieu
    plt.annotate("f0", xy=(x0, f0))
    plt.scatter(x0, 0, color='black')  # Milieu axe x
    plt.annotate("x0", xy=(x0, 0))

    plt.grid()
    plt.legend()
    plt.show()
